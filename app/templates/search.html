{% extends "base.html" %}
{% block content %}

<h1>Spell Search</h1>

<form id="search-form" hx-get="/search" hx-target="#results" hx-trigger="submit" hx-push-url="true">
  <input
    type="text"
    id="search-input"
    name="q"
    placeholder="Search Spells..."
    value="{{ request.query_params.get('q', '') }}"
    hx-get="/search"
    hx-trigger="keyup changed delay:200ms"
    hx-target="#results"
    hx-push-url="true"
  />
</form>

<div id="results">
  <!-- Search results will be inserted here by HTMX -->
  {% if request.query_params.get('q') %}
    {% include "spell_card.html" %}
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const searchForm = document.getElementById('search-form');
    const resultsDiv = document.getElementById('results');
    
    // Trigger search on page load if there's a query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const searchQuery = urlParams.get('q');
    
    if (searchQuery) {
      // Set the input value
      searchInput.value = searchQuery;
      
      // Trigger the search
      htmx.trigger(searchForm, 'submit');
    }
    
    // Update URL when searching
    searchInput.addEventListener('input', function() {
      const params = new URLSearchParams();
      params.set('q', this.value);
      const newUrl = `${window.location.pathname}?${params.toString()}`;
      history.pushState({}, '', newUrl);
    });

    // Handle back/forward navigation
    window.addEventListener('popstate', function() {
      const params = new URLSearchParams(window.location.search);
      if (searchInput) {
        searchInput.value = params.get('q') || '';
        // Trigger HTMX to update the results
        htmx.trigger(searchInput, 'keyup');
      }
    });
  });
</script>

<div id="results"></div>

{% endblock %}
