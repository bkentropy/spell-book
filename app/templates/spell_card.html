{% for spell in spells %}
<div class="spell-card">
  <div class="spell-header" onclick="toggleSpellDetails(this)">
    <div class="spell-header-content">
      <h3>{{ spell.name }}</h3>
      <div class="spell-meta">
        <span class="spell-level">Level {{ spell.level }}</span>
        <span class="spell-school">
          {% if spell.school is string %}
            {{ spell.school }}
          {% else %}
            {{ spell.school.name }}
          {% endif %}
        </span>
      </div>
    </div>
    <button class="toggle-details" aria-label="Toggle spell details">
      <span class="toggle-icon">â–¼</span>
    </button>
  </div>
  
  <div class="spell-details" style="display: none;">
    <div class="spell-basics">
      <p><strong>Casting Time:</strong> {{ spell.casting_time }}</p>
      <p><strong>Range:</strong> {{ spell.range }}</p>
      <p><strong>Components:</strong> 
        {{ ', '.join(spell.components) }}
        {% if spell.material %}({{ spell.material }}){% endif %}
      </p>
      <p><strong>Duration:</strong> 
        {{ spell.duration }}{% if spell.concentration %}, Concentration{% endif %}
      </p>
    </div>
    
    <div class="spell-description">
      <h4>Description:</h4>
      {% for paragraph in spell.desc %}
        <p>{{ paragraph }}</p>
      {% endfor %}
    </div>
    
    {% if spell.higher_level %}
      <div class="higher-level">
        <h4>At Higher Levels:</h4>
        {% for paragraph in spell.higher_level %}
          <p>{{ paragraph }}</p>
        {% endfor %}
      </div>
    {% endif %}
    
    {% if spell.damage and spell.damage.damage_type and spell.damage.damage_type.name %}
    <div class="spell-damage">
      <h4>Damage Information:</h4>
      <p><strong>Damage Type:</strong> {{ spell.damage.damage_type.name }}</p>
      {% if spell.damage.damage_at_slot_level and spell.damage.damage_at_slot_level is mapping %}
        <div class="damage-levels">
          <p><strong>Damage by Spell Level:</strong></p>
          <ul>
            {% for level, damage in spell.damage.damage_at_slot_level.items() %}
              <li>Level {{ level }}: {{ damage }} {{ spell.damage.damage_type.name }} damage</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </div>
    {% endif %}
    
    {% if spell.classes %}
    <div class="spell-classes">
      <h4>Available to:</h4>
      <p>
        {% if spell.classes is string %}
          {{ spell.classes }}
        {% elif spell.classes is mapping %}
          {{ spell.classes.name }}
        {% elif spell.classes is iterable %}
          {% for class in spell.classes %}
            {% if class is mapping %}
              {{ class.name }}{% if not loop.last %}, {% endif %}
            {% else %}
              {{ class }}{% if not loop.last %}, {% endif %}
            {% endif %}
          {% endfor %}
        {% else %}
          {{ spell.classes }}
        {% endif %}
      </p>
    </div>
    {% endif %}
  </div>
</div>
{% endfor %}

<style>
.spell-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  padding: 0.5rem;
  background-color: #f5f5f5;
  border-radius: 4px;
  margin-bottom: 0.5rem;
}

.spell-header:hover {
  background-color: #e9e9e9;
}

.spell-header-content {
  flex-grow: 1;
}

.toggle-details {
  background: none;
  border: none;
  font-size: 1rem;
  cursor: pointer;
  padding: 0.25rem 0.5rem;
  margin-left: 0.5rem;
  border-radius: 4px;
  transition: transform 0.2s ease;
}

.spell-card.expanded .toggle-details .toggle-icon {
  transform: rotate(180deg);
}

.spell-details {
  padding: 0.5rem;
  margin-top: 0.5rem;
  border: 1px solid #eee;
  border-radius: 4px;
  background-color: #fafafa;
  transition: all 0.3s ease;
  overflow: hidden;
}
</style>

<script>
function toggleSpellDetails(header, forceExpand = false) {
  const card = header.parentElement;
  const details = header.nextElementSibling;
  const isExpanded = forceExpand || card.classList.toggle('expanded');
  
  if (isExpanded) {
    details.style.display = 'block';
    // Set height to auto to get the full height
    const fullHeight = details.scrollHeight + 'px';
    details.style.height = '0';
    // Trigger reflow
    void details.offsetHeight; // This forces a reflow
    // Animate to full height
    details.style.height = fullHeight;
    
    // After animation completes, set height to auto to handle window resizing
    setTimeout(() => {
      if (card.classList.contains('expanded') || forceExpand) {
        details.style.height = 'auto';
      }
    }, 300);
  } else {
    // Collapse
    details.style.height = details.scrollHeight + 'px';
    // Trigger reflow
    void details.offsetHeight; // This forces a reflow
    details.style.height = '0';
    // After animation completes, set display to none
    setTimeout(() => {
      if (!card.classList.contains('expanded') && !forceExpand) {
        details.style.display = 'none';
      }
    }, 300);
  }
  
  // Update ARIA attributes for accessibility
  const button = header.querySelector('.toggle-details');
  if (button) {
    button.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
  }
}

// Initialize all collapsible sections
document.addEventListener('DOMContentLoaded', function() {
  // Check if we have a search query in the URL
  const urlParams = new URLSearchParams(window.location.search);
  const hasSearchQuery = urlParams.has('q');
  
  document.querySelectorAll('.spell-details').forEach(details => {
    // Set initial state
    details.style.height = '0';
    details.style.display = 'none';
    
    // If this is a search result page with a query, expand the first result
    if (hasSearchQuery && details === document.querySelector('.spell-details')) {
      // Small delay to ensure all elements are properly initialized
      setTimeout(() => {
        const header = details.previousElementSibling;
        if (header && header.classList.contains('spell-header')) {
          toggleSpellDetails(header, true);
        }
      }, 50);
    }
  });
  
  // Update the search input with the current query
  const searchInput = document.querySelector('input[name="q"]');
  if (searchInput && hasSearchQuery) {
    searchInput.value = urlParams.get('q');
  }
});
</script>
